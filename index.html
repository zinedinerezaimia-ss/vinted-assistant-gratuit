<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VintedAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1a1b1e; color: white; }
        .dropzone { border: 2px dashed #00ffff; border-radius: 1rem; padding: 2rem; text-align: center; cursor: pointer; }
        .dropzone:hover { border-color: #00bfff; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-between p-4">
    <header class="w-full text-center py-4">
        <h1 class="text-2xl font-bold text-cyan-400">üõçÔ∏è VintedAI</h1>
    </header>
    <main class="flex-grow w-full max-w-md">
        <p class="text-lg mb-4">1. AJOUTE TA PHOTO</p>
        <label for="photoInput" class="dropzone bg-gray-800 block"> <!-- Label pour trigger fiable sur clic -->
            <span class="text-4xl mb-2">üì∑</span>
            <p>Clique ou d√©pose ta photo ici</p>
        </label>
        <input type="file" id="photoInput" accept="image/*" multiple class="hidden"> <!-- Retir√© capture pour multiple ; mobile propose cam√©ra anyway -->
        <div id="preview" class="mt-4 flex flex-wrap gap-2"></div>
    </main>
    <footer class="w-full max-w-md">
        <button id="analyzeBtn" class="w-full bg-cyan-500 text-white py-3 rounded-lg font-bold mt-4">Analyser</button>
        <div id="progress" class="hidden mt-4 text-center">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-cyan-400"></div>
            <p>Analyse en cours...</p>
        </div>
        <div id="result" class="mt-4 hidden"></div>
    </footer>

    <script>
        const dropzone = document.querySelector('.dropzone');
        const photoInput = document.getElementById('photoInput');
        const preview = document.getElementById('preview');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const progress = document.getElementById('progress');
        const resultDiv = document.getElementById('result');

        let selectedFiles = []; // Variable pour stocker files (fix drop/upload)

        // Drag & drop sur dropzone
        dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('border-cyan-400'); });
        dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-cyan-400'));
        dropzone.addEventListener('drop', e => {
            e.preventDefault();
            dropzone.classList.remove('border-cyan-400');
            handleFiles(e.dataTransfer.files);
        });

        // Changement input (inclut cam√©ra sur mobile)
        photoInput.addEventListener('change', () => handleFiles(photoInput.files));

        function handleFiles(files) {
            selectedFiles = Array.from(files); // Stocke ici
            preview.innerHTML = '';
            selectedFiles.forEach(file => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.classList.add('w-20 h-20 object-cover rounded');
                preview.appendChild(img);
            });
        }

        analyzeBtn.addEventListener('click', async () => {
            if (!selectedFiles.length) return alert('Ajoute au moins une photo !'); // Check client-side
            progress.classList.remove('hidden');
            resultDiv.classList.add('hidden');

            const formData = new FormData();
            selectedFiles.forEach((file, i) => formData.append(`photo${i}`, file)); // Envoie √† partir de selectedFiles

            try {
                const response = await fetch('/.netlify/functions/process', { method: 'POST', body: formData });
                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                progress.classList.add('hidden');
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <h3 class="text-lg font-bold mb-2">R√©sultats (√©dite si besoin)</h3>
                        <label class="block mb-1">Titre</label>
                        <input type="text" class="w-full bg-gray-700 p-2 rounded mb-2" id="titre" value="${data.titre || 'Titre par d√©faut'}">
                        <button class="bg-gray-600 py-1 px-2 rounded copy-btn" data-target="titre">Copier</button>
                        <label class="block mb-1 mt-4">Description</label>
                        <textarea class="w-full bg-gray-700 p-2 rounded mb-2" rows="4" id="description">${data.description || 'Description par d√©faut'}</textarea>
                        <button class="bg-gray-600 py-1 px-2 rounded copy-btn" data-target="description">Copier</button>
                        <label class="block mb-1 mt-4">Cat√©gorie</label>
                        <select class="w-full bg-gray-700 p-2 rounded mb-2" id="categorie">
                            <option>${data.categorie || 'V√™tements femmes'}</option>
                            <option>V√™tements femmes</option>
                            <option>Chaussures femmes</option>
                            <option>Sacs femmes</option>
                            <option>Accessoires femmes</option>
                            <option>V√™tements hommes</option>
                            <option>Chaussures hommes</option>
                            <!-- Ajoute d'autres cat√©gories Vinted -->
                        </select>
                        <button class="bg-gray-600 py-1 px-2 rounded copy-btn" data-target="categorie">Copier</button>
                        <label class="block mb-1 mt-4">Prix</label>
                        <input type="text" class="w-full bg-gray-700 p-2 rounded mb-2" id="prix" value="${data.prix || '15.00'} ‚Ç¨">
                        <button class="bg-gray-600 py-1 px-2 rounded copy-btn" data-target="prix">Copier</button>
                        <p class="text-sm mt-4">${data.conseil || 'Prix moyen estim√©'}</p>
                    </div>
                `;

                // Boutons copier
                document.querySelectorAll('.copy-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const target = document.getElementById(btn.dataset.target);
                        navigator.clipboard.writeText(target.value);
                        btn.textContent = 'Copi√© !';
                        setTimeout(() => btn.textContent = 'Copier', 2000);
                    });
                });
            } catch (err) {
                progress.classList.add('hidden');
                resultDiv.classList.remove('hidden');
                resultDiv.innerHTML = `<div class="bg-red-900 p-4 rounded-lg">Erreur : ${err.message}. V√©rifie ta connexion ou r√©essaie.</div>`;
            }
        });
    </script>
</body>
</html>
